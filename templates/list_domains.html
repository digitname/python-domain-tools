{% extends "base.html" %}

{% block title %}Domain List - Domain Extractor{% endblock %}

{% block content %}
    <h1>Domain List</h1>

    <form method="GET" action="{{ url_for('list_domains') }}">
        <input type="text" name="search" value="{{ search_query }}" placeholder="Search domains">
        <select name="category">
            <option value="">All Categories</option>
            {% for category in categories %}
            <option value="{{ category }}" {% if category == category_filter %}selected{% endif %}>{{ category }}</option>
            {% endfor %}
        </select>
        <button type="submit">Search</button>
    </form>

    <table class="table">
        <thead>
            <tr>
                <th>Domain</th>
                <th>Category</th>
            </tr>
        </thead>
        <tbody>
            {% for domain in domains %}
            <tr>
                <td>{{ domain.name }}</td>
                <td>{{ domain.category }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <nav aria-label="Page navigation">
        <ul class="pagination">
            {% if pagination.has_prev %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('list_domains', page=pagination.prev_num, search=search_query, category=category_filter) }}">Previous</a>
            </li>
            {% endif %}
            {% for page in pagination.iter_pages() %}
            {% if page %}
                {% if page != pagination.page %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('list_domains', page=page, search=search_query, category=category_filter) }}">{{ page }}</a>
                </li>
                {% else %}
                <li class="page-item active">
                    <span class="page-link">{{ page }}</span>
                </li>
                {% endif %}
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">...</span>
                </li>
            {% endif %}
            {% endfor %}
            {% if pagination.has_next %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('list_domains', page=pagination.next_num, search=search_query, category=category_filter) }}">Next</a>
            </li>
            {% endif %}
        </ul>
    </nav>
{% endblock %}

{% block extra_js %}
<script>
    function updateRemoveSelectedButton() {
        const checkboxes = document.querySelectorAll('.domain-checkbox:checked');
        document.getElementById('remove-selected').disabled = checkboxes.length === 0;
    }

    document.getElementById('search').addEventListener('input', () => document.getElementById('filter-form').submit());
    document.getElementById('category').addEventListener('change', () => document.getElementById('filter-form').submit());

    document.getElementById('remove-ns').addEventListener('click', () => {
        fetch('/api/remove_ns', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                updateDomains();
            });
    });

    document.getElementById('remove-subdomains').addEventListener('click', () => {
        fetch('/api/remove_subdomains', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                updateDomains();
            });
    });

    document.getElementById('remove-selected').addEventListener('click', () => {
        const selectedDomains = Array.from(document.querySelectorAll('.domain-checkbox:checked'))
            .map(checkbox => checkbox.getAttribute('data-domain'));
        fetch('/api/remove_selected', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ domains: selectedDomains }),
        })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                updateDomains();
            });
    });

    document.addEventListener('change', (e) => {
        if (e.target.id === 'select-all') {
            document.querySelectorAll('.domain-checkbox').forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
        }
        if (e.target.classList.contains('domain-checkbox') || e.target.id === 'select-all') {
            updateRemoveSelectedButton();
        }
    });

    // Initial load
    updateDomains();
</script>
{% endblock %}
