{% extends "base.html" %}

{% block title %}Domain List - Domain Extractor{% endblock %}

{% block content %}
    <h1>Domain List</h1>
    <form id="filter-form" class="mb-4">
        <div class="form-row">
            <div class="col">
                <input type="text" id="search" name="search" class="form-control" placeholder="Search domains..." value="{{ search_query }}">
            </div>
            <div class="col">
                <select id="category" name="category" class="form-control">
                    <option value="">All Categories</option>
                    {% for category in categories %}
                    <option value="{{ category }}" {% if category == category_filter %}selected{% endif %}>{{ category }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </form>

    <div class="mb-3">
        <button id="remove-ns" class="btn btn-warning">Remove NS Servers</button>
        <button id="remove-subdomains" class="btn btn-warning">Remove Subdomains</button>
        <button id="remove-selected" class="btn btn-danger" disabled>Remove Selected</button>
    </div>

    <div id="domains-table">
        <!-- This will be populated dynamically -->
    </div>

    <div id="pagination">
        <!-- This will be populated dynamically -->
    </div>
{% endblock %}

{% block extra_js %}
<script>
    function updateDomains(page = 1) {
        const search = document.getElementById('search').value;
        const category = document.getElementById('category').value;
        
        fetch(`/api/list_domains?page=${page}&search=${search}&category=${category}`)
            .then(response => response.json())
            .then(data => {
                const tableHtml = `
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all"></th>
                                <th>Domain</th>
                                <th>Category</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.domains.map(domain => `
                                <tr>
                                    <td><input type="checkbox" class="domain-checkbox" data-domain="${domain.domain}"></td>
                                    <td>${domain.domain}</td>
                                    <td>${domain.category}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                document.getElementById('domains-table').innerHTML = tableHtml;
                document.getElementById('pagination').innerHTML = data.pagination;
                updateRemoveSelectedButton();
            });
    }

    function updateRemoveSelectedButton() {
        const checkboxes = document.querySelectorAll('.domain-checkbox:checked');
        document.getElementById('remove-selected').disabled = checkboxes.length === 0;
    }

    document.getElementById('search').addEventListener('input', () => updateDomains());
    document.getElementById('category').addEventListener('change', () => updateDomains());
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('page-link')) {
            e.preventDefault();
            const page = e.target.getAttribute('data-page');
            updateDomains(page);
        }
    });

    document.getElementById('remove-ns').addEventListener('click', () => {
        fetch('/api/remove_ns', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                updateDomains();
            });
    });

    document.getElementById('remove-subdomains').addEventListener('click', () => {
        fetch('/api/remove_subdomains', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                updateDomains();
            });
    });

    document.getElementById('remove-selected').addEventListener('click', () => {
        const selectedDomains = Array.from(document.querySelectorAll('.domain-checkbox:checked'))
            .map(checkbox => checkbox.getAttribute('data-domain'));
        fetch('/api/remove_selected', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ domains: selectedDomains }),
        })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                updateDomains();
            });
    });

    document.addEventListener('change', (e) => {
        if (e.target.id === 'select-all') {
            document.querySelectorAll('.domain-checkbox').forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
        }
        if (e.target.classList.contains('domain-checkbox') || e.target.id === 'select-all') {
            updateRemoveSelectedButton();
        }
    });

    // Initial load
    updateDomains();
</script>
{% endblock %}
